# 数据库

## 数据库操作

几乎每个应用程序都需要一个数据库，特别是如果你的应用程序处理复杂的用户数据或与 API 通信。数据库是跨多个应用程序版本持久化结构化数据的高效且可靠的方式。

在构建 _服务器端_ 应用程序时，你可以自由选择你喜欢的数据库引擎。但在自包含的本地应用程序的上下文中，你的选择仅限于：

* 你可以合理地与你的应用程序捆绑的内容；或
* 你可以期望用户的系统已安装的内容。

**为了保持应用程序的足迹小，NativePHP 目前仅原生支持 SQLite。**

你可以通过 PDO 或 ORM（如 Eloquent）以你习惯的方式与 SQLite 交互。

### SQLite

[SQLite](https://sqlite.org/) 是一个功能丰富、便携、轻量级的基于文件的数据库。它非常适合需要以 SQL 的速度和工具持久存储复杂数据结构的原生应用程序。

它的小足迹和最小的依赖性使其非常适合跨平台的原生应用程序。你的用户除了你的应用程序之外不需要安装任何其他东西，它不会为你的包增加数百 MB，从而保持下载和安装大小较小。

#### 配置

你不需要做任何特殊的事情来配置你的应用程序以使用 SQLite。NativePHP 将自动：

* 在构建你的应用程序时切换到使用 SQLite
* 在用户的系统上的 `appdata` 目录中为你创建一个数据库文件
* 配置你的应用程序以使用该数据库文件
* 根据需要每次启动应用程序时运行你的迁移

### 开发

记住，在 开发 中，你的应用程序的数据库始终是为你应用程序创建的 SQLite 数据库，位于 `appdata` 文件夹中。

这意味着即使你在 `.env` 文件中有不同的配置，当你的应用程序在 Electron/Tauri 环境中运行时，它也不会连接到任何其他数据库。

### 迁移

在编写迁移时，你需要考虑与 SQLite 一起工作的任何特殊建议。

例如，在 Laravel 11 之前，SQLite 外键约束默认是关闭的。如果你的应用程序依赖于外键约束，[你需要在运行迁移之前启用 SQLite 对它们的支持](https://laravel.com/docs/database#configuration)。

**在发布更新之前，在生产构建上测试你的迁移非常重要！** 你不希望在用户更新你的应用程序时意外删除他们的数据。

#### 运行迁移

NativePHP 将尝试在每次启动时迁移你的数据库。

在开发过程中，你可能还希望手动迁移它。无论应用程序是否正在运行，你都可以这样做，但根据你的应用程序的行为，最好在打开应用程序之前进行迁移。

你可以使用 `native:migrate` 命令来执行此操作：

```shell
php artisan native:migrate
```

此命令使用与 Laravel `migrate` 命令完全相同的签名，因此你习惯的所有内容都可以在这里使用。

#### 刷新你的应用程序数据库

你可以使用 `native:migrate:fresh` 命令完全刷新你的应用程序数据库：

```shell
php artisan native:migrate:fresh
```

**这是一个破坏性操作，将删除数据库中的所有数据。**

### 播种

在开发过程中，使用示例数据播种你的数据库特别有用。如果你已经设置了 [数据库播种器](https://laravel.com/docs/seeding)，你可以使用 `native:db:seed` 命令运行这些播种器：

```shell
php artisan native:db:seed
```

### 何时不应使用数据库

如果你只存储少量非常简单的元数据或工作文件，你可能根本不需要数据库。考虑 存储文件 代替。这些可以是 JSON、CSV、纯文本或对你的应用程序有意义的任何其他格式。

对于用户设备上应用程序状态的非常关键的元数据，也请考虑使用文件存储。如果你依赖存储用户数据的数据库来存储此信息，如果数据库因任何原因损坏，你的应用程序可能根本无法启动。

如果你将此信息存储在文件中，至少可以指导用户删除文件并重新启动应用程序，降低删除他们数据的风险。
